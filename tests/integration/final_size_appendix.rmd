---
title: "Appendix on epidemic final size"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  out.width = "100%",
  fig.width = 10,
  fig.align = "center"
)
```
One of the characteristics of simulated epidemics that can be checked in integration tests is the "final size", i.e., the proportion of persons who have become infected after an SIR-type epidemic has run through a population and there are no longer any infectious persons remaining. The purpose of this document is to briefly review the underlying mathematics and to generate code that can be used to calculate final size.

### Final size relation for canonical SIR (Kermack and McKendrick) ODE model
The following is based on Brauer et al. 2019. (See also Miller 2012 and Ma and Earn 2006). We begin with the standard formulation of the model.

$$
\frac{dS(t)}{dt} = -\beta S(t) I(t)
$$
$$
\frac{dI(t)}{dt} = \beta S(t) I(t) - \alpha I(t)
$$
$$
\frac{dR(t)}{dt} = \alpha I(t)
$$

In this formulation $S(t)+I(t)+R(t)=N$ and we will assume that $R(0)=0$. We know that $I(\infty) = 0$. The total number of persons infected is $R(\infty) = N - S(\infty)$. In this model $\mathscr{R}_0=\beta N/\alpha$.

Note that $R(\infty)/\alpha = \int_0^\infty I(t)dt$. An intuitive explanation for this relationship is that $\int_0^\infty I(t)dt$ is the cumulative amount of person-time spent in the $I$ compartment over the entire epidemic and since $\alpha$ is the inverse of the mean duration of infectiousness for each infected individual, therefore $R(\infty)/\alpha$ is the total number of people infected times the mean duration of infectiousness, which is by definition the amount of infectious person-time.

Next, we want to get $\int_0^\infty I(t)dt$ in terms of $S(0)$, $S(\infty)$ and $\beta$. We will multiple the equation for $\frac{dS(t)}{dt}$ by $1/S(t)$ and integrate from $t = 0$ to $t = \infty$.

$$\frac{1}{S(t)}\frac{dS(t)}{dt} = \frac{1}{S(t)} (-\beta S(t) I(t))$$

$$\frac{1}{S(t)}\frac{dS(t)}{dt} = -\beta I(t)$$

$$\int_0^\infty \frac{1}{S(t)}\frac{dS(t)}{dt} dt = \int_0^\infty-\beta I(t) dt$$

$$\ln(S(t)) \bigg|_0^\infty = -\beta\int_0^\infty I(t) dt$$

$$\ln(S(\infty)) - \ln(S(0)) = -\beta\int_0^\infty I(t) dt$$

Substituting in using $\int_0^\infty I(t)dt = R(\infty)/\alpha$, we get

$$\ln\bigg(\frac{S(\infty)}{S(0)}\bigg) = -\beta \frac{R(\infty)}{\alpha}$$

Reparameterizing in terms of $\mathscr{R}_0$ yields

$$\ln\bigg(\frac{S(\infty)}{S(0)}\bigg) = -\mathscr{R}_0 \frac{R(\infty)}{N}$$

$$\frac{S(\infty)}{S(0)} = \exp\bigg(-\mathscr{R}_0 \frac{R(\infty)}{N}\bigg)$$


$$\frac{N-R(\infty)}{S(0)} = \exp\bigg(-\mathscr{R}_0 \frac{R(\infty)}{N}\bigg)$$

Let the final size $Z = \frac{R(\infty)}{N}$ and the initial infected proportion $Y = \frac{I(0)}{N}$. Therefore

$$\frac{1-Z}{1-Y} = \exp(-\mathscr{R}_0 Z)$$
$$Z = 1-(1-Y)\exp(-\mathscr{R}_0 Z)$$

If we are willing to assume that $I(0)$ is very small relative to $N$, then $Y\approx 0$ and we get the simpler expression $Z = 1-\exp(-\mathscr{R}_0Z)$. We can solve $Z$ numerically if we know $\mathscr{R}_0$ and $Y$.

```{r}
final_size_fx <- function(r0, y = 1e-10) {
  uniroot(
    f = function(z) {
      exp(-r0 * z) - (1 - z) / (1 - y)
    },
    interval = c(y, 1)
  )$root
}

r0_values <- seq(from = 0, to = 5, by = 0.01)

x_for_y_0 <- sapply(X = r0_values, FUN = final_size_fx)
x_for_y_0_001 <- sapply(X = r0_values, FUN = final_size_fx, y = 0.001)
x_for_y_0_01 <- sapply(X = r0_values, FUN = final_size_fx, y = 0.01)
x_for_y_0_1 <- sapply(X = r0_values, FUN = final_size_fx, y = 0.1)

herd_immunity_threshold <- 1 - 1 / r0_values[r0_values >= 1]

plot(
  x = r0_values, y = x_for_y_0, type = "l", col = "black",
  xlab = expression(italic(R[0])),
  ylab = expression(paste("final size, ", italic(Z)))
)
points(x = r0_values, y = x_for_y_0_001, type = "l", col = "blue")
points(x = r0_values, y = x_for_y_0_01, type = "l", col = "purple")
points(x = r0_values, y = x_for_y_0_1, type = "l", col = "red")
points(
  x = r0_values[r0_values >= 1],
  y = herd_immunity_threshold, type = "l", col = "darkgrey", lty = 2
)
legend("bottomright",
  legend = c(
    expression(paste("initial size, ", italic(Y = 0))),
    expression(paste("initial size, ", italic(Y = 0.001))),
    expression(paste("initial size, ", italic(Y = 0.01))),
    expression(paste("initial size, ", italic(Y = 0.1))),
    "herd immunity threshold"
  ), lty = c(1, 1, 1, 1, 2),
  col = c("black", "blue", "purple", "red", "darkgrey")
)
```

### Final size distribution for stochastic SIR epidemic in a finite population

The approach in Miller 2019 for calculating the distribution of epidemic final sizes in a finite population relies on the probability generating function $\mu(x) = \sum_\ell p_\ell x^\ell$ where $p_\ell$ is the probability that an infection causes $\ell$ onward transmission attempts (i.e., these probabilities define the offspring distribution). For the SIR model with exponentially distributed duration of infectiousness, the offspring distribution follows a geometric distribution. The probability generating function for the geometric distribution parameterized in terms of $\mathscr{R}_0$ is $\mu(x) = 1/(1+\mathscr{R}_0(1-x))$ (Lloyd-Smith et al. 2005).

```{r, eval=FALSE}
# check PGFs empirically

r_0 <- 2
x_vec <- (1:50) / 10
l_vec <- 0:1000 # would in theory ideally go to infinity

# trying for the Poisson distribution

p_l <- dpois(x = l_vec, lambda = r_0)

for (x in x_vec) {
  print(x)
  print(sum(p_l * x^l_vec))
  print(exp(r_0 * (x - 1)))
}

# trying for the geometric distribution

p_l <- dnbinom(x = l_vec, size = 1, mu = r_0, log = TRUE)

for (x in x_vec) {
  print(x)
  print(sum(exp(p_l + l_vec * log(x))))
  print(1 / (1 + r_0 - r_0 * x))
}
```

Suppose we have a population of size $N$. We want to calculate the probability $q_k$ that a single introduced infection will result in an epidemic final size of $k$, for $k \in \{1, \ldots, N\}$. Values for $q_k$ can be obtained by solving a system of linear equations where the coefficient $c_{k,M}$ is the element in the $k$-th column and $M$-th row in an $N \times N$ lower-triangular matrix. The values for the first column are calculated as
$$
c_{1,M} = 1+\mathscr{R}_0\bigg(1-\frac{M-1}{N-1}\bigg)
$$
and the coefficients in columns $k>1$ are
$$
c_{k,M} = \frac{M-k+1}{N-k+1}\bigg[1+\mathscr{R}_0\bigg(1-\frac{M-1}{N-1}\bigg)\bigg]c_{k-1,M}
$$

We can calculate the values for $q_k$ and plot the distribution. Shown here is the distribution of epidemic final size for $N=100$ and $\mathscr{R}_0=3$.

```{r}
# when trying to empirically obtain values for q_k, we encounter some numerical
# instability issues; using the Rmpfr package for "Multiple Precision
# Floating-Point Reliably" helps solve this issue.

r_0 <- 3
n <- 100

library(Rmpfr)

precision <- 128 * 4 # necessary precision depends on parameters
# this should work for N = 1000 and R0 = 3, which runs in a little over 2 mins

nxn_mat <- mpfr(matrix(nrow = n, ncol = n), precision)
m_vec <- mpfr(seq_len(n), precision)
r_0 <- mpfr(r_0, precision)
c_1_m <- 1 + r_0 * (1 - (m_vec - 1) / (n - 1))

nxn_mat[, 1] <- c_1_m

for (k in 2:n) {
  nxn_mat[, k] <- (m_vec - k + 1) / (n - k + 1) * c_1_m * nxn_mat[, k - 1]
}

l <- nxn_mat
b <- mpfr(matrix(data = 1, nrow = n, ncol = 1), precision)

x <- mpfr(rep(0, n), precision)

# the following loop is equivalent to the function forwardsolve
for (i in 1:n) {
  sum_lx <- mpfr(0, precision)
  if (i > 1) {
    sum_lx <- sum(l[i, 1:(i - 1)] * x[1:(i - 1)])
  }
  x[i] <- (b[i] - sum_lx) / l[i, i]
}

plot(x = m_vec, y = x, xlab = "k", ylab = expression(q[k]))
```

To further illustrate this distribution, we can plot $\log(q_k)$ and the cumulative distribution function of $q_k$.

```{r}
plot(x = m_vec, y = log(x), xlab = "k", ylab = "log(" ~ q[k] ~ ")")
plot(x = m_vec, y = cumsum(x), xlab = "k", ylab = "CDF of " ~ q[k])
```

### References
1. Brauer F, Castillo-Chavez C, Feng Z. Mathematical models in epidemiology. New York: Springer; 2019 Feb 20.
2. Lloyd-Smith JO, Schreiber SJ, Kopp PE, Getz WM. Superspreading and the effect of individual variation on disease emergence. Nature. 2005 Nov 17;438(7066):355-9.
3. Ma J, Earn DJ. Generality of the final size formula for an epidemic of a newly invading infectious disease. Bulletin of mathematical biology. 2006 Apr;68:679-702.
3. Miller JC. A note on the derivation of epidemic final sizes. Bulletin of mathematical biology. 2012 Sep;74(9):2125-41.
4. Miller JC. Distribution of outbreak sizes for SIR disease in finite populations. arXiv preprint arXiv:1907.05138. 2019 Jul 11.
