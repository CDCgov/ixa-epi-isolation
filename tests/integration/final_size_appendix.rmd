---
title: "Appendix on epidemic final size"
output: html_document
---
One of the characteristics of simulated epidemics that can be checked in integration tests is the "final size", i.e., the proportion of persons who have become infected after an SIR-type epidemic has run through a population and there are no longer any infectious persons remaining. The purpose of this document is to briefly review the underlying mathematics and to generate code that can be used to calculate final size.

### Final size relation for canonical SIR (Kermack and McKendrick) ODE model
The following is based on Brauer et al. 2019. (See also Miller 2012 and Ma and Earn 2006). We begin with the standard formulation of the model.

$$
\frac{dS(t)}{dt} = -\beta S(t) I(t)
$$
$$
\frac{dI(t)}{dt} = \beta S(t) I(t) - \alpha I(t)
$$
$$
\frac{dR(t)}{dt} = \alpha I(t)
$$

In this formulation $S(t)+I(t)+R(t)=N$ and we will assume that $R(0)=0$. We know that $I(\infty) = 0$. The total number of persons infected is $R(\infty) = N - S(\infty)$. In this model $\mathscr{R}_0=\beta N/\alpha$.

Note that $R(\infty)/\alpha = \int_0^\infty I(t)dt$. An intuitive explanation for this relationship is that $\int_0^\infty I(t)dt$ is the cumulative amount of person-time spent in the $I$ compartment over the entire epidemic and since $\alpha$ is the inverse of the mean duration of infectiousness for each infected individual, therefore $R(\infty)/\alpha$ is the total number of people infected times the mean duration of infectiousness, which is by definition the amount of infectious person-time.

Next, we want to get $\int_0^\infty I(t)dt$ in terms of $S(0)$, $S(\infty)$ and $\beta$. We will multiple the equation for $\frac{dS(t)}{dt}$ by $1/S(t)$ and integrate from $t = 0$ to $t = \infty$.

$$\frac{1}{S(t)}\frac{dS(t)}{dt} = \frac{1}{S(t)} (-\beta S(t) I(t))$$

$$\frac{1}{S(t)}\frac{dS(t)}{dt} = -\beta I(t)$$

$$\int_0^\infty \frac{1}{S(t)}\frac{dS(t)}{dt} dt = \int_0^\infty-\beta I(t) dt$$

$$\ln(S(t)) \bigg|_0^\infty = -\beta\int_0^\infty I(t) dt$$

$$\ln(S(\infty)) - \ln(S(0)) = -\beta\int_0^\infty I(t) dt$$

Substituting in using $\int_0^\infty I(t)dt = R(\infty)/\alpha$, we get

$$\ln\bigg(\frac{S(\infty)}{S(0)}\bigg) = -\beta \frac{R(\infty)}{\alpha}$$

Reparameterizing in terms of $\mathscr{R}_0$ yields

$$\ln\bigg(\frac{S(\infty)}{S(0)}\bigg) = -\mathscr{R}_0 \frac{R(\infty)}{N}$$

$$\frac{S(\infty)}{S(0)} = \exp\bigg(-\mathscr{R}_0 \frac{R(\infty)}{N}\bigg)$$


$$\frac{N-R(\infty)}{S(0)} = \exp\bigg(-\mathscr{R}_0 \frac{R(\infty)}{N}\bigg)$$

Let the final size $Z = \frac{R(\infty)}{N}$ and the initial infected proportion $Y = \frac{I(0)}{N}$. Therefore

$$\frac{1-Z}{1-Y} = \exp(-\mathscr{R}_0 Z)$$
$$Z = 1-(1-Y)\exp(-\mathscr{R}_0 Z)$$

If we are willing to assume that $I(0)$ is very small relative to $N$, then $Y\approx 0$ and we get the simpler expression $Z = 1-\exp(-\mathscr{R}_0Z)$. We can solve $Z$ numerically if we know $\mathscr{R}_0$ and $Y$.

```{r, echo = FALSE, warning = FALSE, message = FALSE}

final_size_fx <- function(R0, Y = 1e-10){
    uniroot(f = function(Z){exp(-R0 * Z) - (1 - Z) / (1 - Y)},
    interval = c(Y ,1))$root
}

r0_values <- seq(from = 0, to = 5, by = 0.01)

x_for_y_0 <- sapply(X = r0_values, FUN = final_size_fx)
x_for_y_0_001 <- sapply(X = r0_values, FUN = final_size_fx, Y = 0.001)
x_for_y_0_01 <- sapply(X = r0_values, FUN = final_size_fx, Y = 0.01)
x_for_y_0_1 <- sapply(X = r0_values, FUN = final_size_fx, Y = 0.1)

herd_immunity_threshold <- 1 - 1 / r0_values[r0_values >= 1]

plot(x = r0_values, y = x_for_y_0, type = "l", col = "black",
xlab = expression(italic(R[0])),
ylab = expression(paste("final size, ", italic(Z))))
points(x = r0_values, y = x_for_y_0_001, type = "l", col = "blue")
points(x = r0_values, y = x_for_y_0_01, type = "l", col = "purple")
points(x = r0_values, y = x_for_y_0_1, type = "l", col = "red")
points(x = r0_values[r0_values >= 1],
y = herd_immunity_threshold, type = "l", col = "darkgrey", lty = 2)
legend("bottomright",
legend = c(expression(paste("initial size, ", italic(Y=0))),
           expression(paste("initial size, ", italic(Y=0.001))),
           expression(paste("initial size, ", italic(Y=0.01))),
           expression(paste("initial size, ", italic(Y=0.1))),
           "herd immunity threshold"), lty = c(1,1,1,1,2),
           col = c("black", "blue", "purple", "red", "darkgrey"))

```

### References
1. Brauer F, Castillo-Chavez C, Feng Z. Mathematical models in epidemiology. New York: Springer; 2019 Feb 20.
2. Ma J, Earn DJ. Generality of the final size formula for an epidemic of a newly invading infectious disease. Bulletin of mathematical biology. 2006 Apr;68:679-702.
3. Miller JC. A note on the derivation of epidemic final sizes. Bulletin of mathematical biology. 2012 Sep;74(9):2125-41.
